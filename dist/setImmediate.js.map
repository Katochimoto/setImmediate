{"version":3,"file":"setImmediate.js","sources":["../src/context.js","../src/useNative.js","../src/timer.js","../src/polifill/setTimeout.js","../src/polifill/nextTick.js","../src/polifill/postMessage.js","../src/polifill/messageChannel.js","../src/polifill/readyStateChange.js","../src/index.js"],"sourcesContent":["export default (function () {\n  /* eslint no-eval: 0 */\n  return this || (1, eval)('this');\n})();\n","import context from './context';\n\n// @see http://codeforhire.com/2013/09/21/setimmediate-and-messagechannel-broken-on-internet-explorer-10/\nexport default (function () {\n  return !(context.navigator && /Trident|Edge/.test(context.navigator.userAgent));\n})();\n","import context from './context';\n\nlet nextId = 1;\nlet lock = false;\nconst TASKS = {};\n\nexport function wrap (handler) {\n  const args = Array.prototype.slice.call(arguments, 1);\n  const len = args.length;\n\n  return do {\n    if (!len) {\n      () => handler.call(undefined);\n    } else if (len === 1) {\n      () => handler.call(undefined, args[0]);\n    } else if (len === 2) {\n      () => handler.call(undefined, args[0], args[1]);\n    } else if (len === 3) {\n      () => handler.call(undefined, args[0], args[1], args[2]);\n    } else {\n      () => handler.apply(undefined, args);\n    }\n  };\n}\n\nexport function create (args) {\n  TASKS[ nextId ] = wrap.apply(undefined, args);\n  return nextId++;\n}\n\nexport function clear (handleId) {\n  delete TASKS[ handleId ];\n}\n\nexport function run (handleId) {\n  if (lock) {\n    context.setTimeout( wrap( run, handleId ), 0 );\n\n  } else {\n    const task = TASKS[ handleId ];\n\n    if (task) {\n      lock = true;\n\n      try {\n        task();\n\n      } finally {\n        clear( handleId );\n        lock = false;\n      }\n    }\n  }\n}\n","import context from '../context';\nimport * as Timer from '../timer';\n\nexport function init() {\n  const polifill = function () {\n    const handleId = Timer.create(arguments);\n    context.setTimeout( Timer.wrap( Timer.run, handleId ), 0 );\n    return handleId;\n  };\n\n  polifill.usePolifill = 'setTimeout';\n\n  return polifill;\n};\n\nexport function canUse() {\n  return ('setTimeout' in context);\n};\n","import context from '../context';\nimport * as Timer from '../timer';\n\nexport function init() {\n  const polifill = function () {\n    const handleId = Timer.create(arguments);\n    context.process.nextTick( Timer.wrap( Timer.run, handleId ) );\n    return handleId;\n  };\n\n  polifill.usePolifill = 'nextTick';\n\n  return polifill;\n};\n\n// Don't get fooled by e.g. browserify environments.\n// For Node.js before 0.9\nexport function canUse() {\n  return (Object.prototype.toString.call(context.process) === '[object process]');\n};\n","import context from '../context';\nimport * as Timer from '../timer';\n\nexport function init() {\n  const messagePrefix = 'setImmediate$' + Math.random() + '$';\n\n  const onGlobalMessage = function (event) {\n    if (event.source === context &&\n      typeof(event.data) === 'string' &&\n      event.data.indexOf(messagePrefix) === 0) {\n\n      Timer.run(Number(event.data.slice(messagePrefix.length)));\n    }\n  };\n\n  if (context.addEventListener) {\n    context.addEventListener('message', onGlobalMessage, false);\n\n  } else {\n    context.attachEvent('onmessage', onGlobalMessage);\n  }\n\n  const polifill = function () {\n    const handleId = Timer.create(arguments);\n    context.postMessage(messagePrefix + handleId, '*');\n    return handleId;\n  };\n\n  polifill.usePolifill = 'postMessage';\n\n  return polifill;\n};\n\n// For non-IE10 modern browsers\nexport function canUse() {\n  if (context.importScripts || !context.postMessage) {\n    return false;\n  }\n\n  if (context.navigator && /Chrome/.test(context.navigator.userAgent)) {\n    //skip this method due to heavy minor GC on heavy use.\n    return false;\n  }\n\n  let asynch = true;\n  const oldOnMessage = context.onmessage;\n  context.onmessage = function () {\n    asynch = false;\n  };\n\n  context.postMessage('', '*');\n  context.onmessage = oldOnMessage;\n  return asynch;\n};\n","import context from '../context';\nimport * as Timer from '../timer';\n\nexport function init() {\n  const channel = new context.MessageChannel();\n\n  channel.port1.onmessage = function (event) {\n    Timer.run(Number(event.data));\n  };\n\n  const polifill = function () {\n    const handleId = Timer.create(arguments);\n    channel.port2.postMessage(handleId);\n    return handleId;\n  };\n\n  polifill.usePolifill = 'messageChannel';\n\n  return polifill;\n};\n\n// For web workers, where supported\nexport function canUse() {\n  return Boolean(context.MessageChannel);\n};\n","import context from '../context';\nimport * as Timer from '../timer';\n\nexport function init() {\n  const html = context.document.documentElement;\n\n  const polifill = function () {\n    const handleId = Timer.create(arguments);\n    let script = context.document.createElement('script');\n\n    script.onreadystatechange = function () {\n      Timer.run(handleId);\n      script.onreadystatechange = null;\n      html.removeChild(script);\n      script = null;\n    };\n\n    html.appendChild(script);\n    return handleId;\n  };\n\n  polifill.usePolifill = 'readyStateChange';\n\n  return polifill;\n};\n\n// For IE 6â€“8\nexport function canUse() {\n  return (context.document && ('onreadystatechange' in context.document.createElement('script')));\n};\n","import context from './context';\nimport useNative from './useNative';\nimport * as Timer from './timer';\nimport * as setTimeoutPolifill from './polifill/setTimeout';\nimport * as nextTickPolifill from './polifill/nextTick';\nimport * as postMessagePolifill from './polifill/postMessage';\nimport * as messageChannelPolifill from './polifill/messageChannel';\nimport * as readyStateChangePolifill from './polifill/readyStateChange';\n\nconst POLIFILLS = [\n  nextTickPolifill,\n  postMessagePolifill,\n  messageChannelPolifill,\n  readyStateChangePolifill\n];\n\nconst setImmediate = do {\n  if (useNative) {\n    context.setImmediate || context.msSetImmediate || usePolifill(POLIFILLS, setTimeoutPolifill);\n  } else {\n    setTimeoutPolifill.init();\n  }\n};\n\nconst clearImmediate = do {\n  if (useNative) {\n    context.clearImmediate || context.msClearImmediate || Timer.clear;\n  } else {\n    Timer.clear;\n  }\n};\n\nfunction polifill () {\n  if (context.setImmediate !== setImmediate) {\n    context.setImmediate = setImmediate;\n    context.msSetImmediate = setImmediate;\n    context.clearImmediate = clearImmediate;\n    context.msClearImmediate = clearImmediate;\n  }\n}\n\nfunction usePolifill (list, def) {\n  for (let i = 0; i < list.length; i++) {\n    const polifill = list[ i ];\n    if (polifill.canUse()) {\n      return polifill.init();\n    }\n  }\n\n  return def.init();\n}\n\nexport default {\n  setImmediate,\n  clearImmediate,\n  polifill\n};\n"],"names":["eval","context","navigator","test","userAgent","nextId","lock","TASKS","wrap","handler","args","Array","prototype","slice","call","arguments","len","length","undefined","apply","create","clear","handleId","run","setTimeout","task","init","polifill","Timer","usePolifill","canUse","process","nextTick","Object","toString","messagePrefix","Math","random","onGlobalMessage","event","source","data","indexOf","Number","addEventListener","attachEvent","postMessage","importScripts","asynch","oldOnMessage","onmessage","channel","MessageChannel","port1","port2","Boolean","html","document","documentElement","script","createElement","onreadystatechange","removeChild","appendChild","POLIFILLS","nextTickPolifill","postMessagePolifill","messageChannelPolifill","readyStateChangePolifill","setImmediate","useNative","msSetImmediate","setTimeoutPolifill","clearImmediate","msClearImmediate","list","def","i"],"mappings":"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"}